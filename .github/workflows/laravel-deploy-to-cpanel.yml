name: Laravel Deploy to cPanel

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Build Laravel app
      run: |
        # Only create .env if it does not already exist.
        if [ ! -f .env ]; then
          cp .env.example .env
          php artisan key:generate
        else
          # If .env exists but APP_KEY is missing or empty, generate one.
          APP_KEY_VALUE=$(awk -F= '/^APP_KEY=/{print $2}' .env || true)
          if [ -z "$APP_KEY_VALUE" ]; then
            php artisan key:generate
          fi
        fi
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Upload to cPanel via FTPS (lftp)
      env:
        CP_HOST: ${{ secrets.CPANEL_HOST }}
        CP_USER: ${{ secrets.CPANEL_USERNAME }}
        CP_PASS: ${{ secrets.CPANEL_PASSWORD }}
        CP_PATH: ${{ secrets.CPANEL_DEPLOY_PATH }}
      run: |
        sudo apt-get update -y
        sudo apt-get install -y lftp
        # Use lftp to mirror local repo to remote path via FTPS.
        # Exclude common large/unnecessary dirs; adjust excludes as needed.
        lftp -c "\
          set ftp:ssl-force true; \
          set ftp:ssl-protect-data true; \
          set ssl:verify-certificate false; \
          open -u \"$CP_USER\",\"$CP_PASS\" ftps://$CP_HOST; \
          mirror -R --delete --verbose --parallel=4 \
            --exclude-glob .git* \
            --exclude node_modules \
            --exclude .github \
            ./ \"$CP_PATH\" \
        "
