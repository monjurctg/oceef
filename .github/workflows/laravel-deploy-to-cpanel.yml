name: CI / CD — Laravel to cPanel

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Detect committed credentials (fail if found)
      run: |
        echo "Scanning repository for plaintext credentials..."
        FOUND=$(git grep -nE --no-color 'CPANEL_USERNAME|CPANEL_PASSWORD|CPANEL_PASS|cpanel_username|cpanel_password' || true)
        CRED_URLS=$(git grep -nE --no-color '://[^@[:space:]]+@' || true)
        if [ -n "$FOUND" ] || [ -n "$CRED_URLS" ]; then
          echo "Potential plaintext credentials found in repository:"
          [ -n "$FOUND" ] && echo "$FOUND"
          [ -n "$CRED_URLS" ] && echo "$CRED_URLS"
          echo ""
          echo "ACTION REQUIRED: Remove these credentials from the repository, add them to"
          echo "Repository Settings → Secrets (CPANEL_HOST, CPANEL_USERNAME, CPANEL_PASSWORD),"
          echo "and rotate the compromised credentials in cPanel immediately."
          exit 1
        fi
        echo "No obvious plaintext credentials detected."

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: ~/.composer/cache
        key: composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: composer-

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer dependencies
      run: composer install --no-interaction --prefer-dist --no-progress

    - name: Run tests (phpunit if present)
      run: |
        if [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
          vendor/bin/phpunit --colors=never || (echo "Tests failed"; exit 1)
        else
          echo "No phpunit config found — skipping tests"
        fi

    - name: Basic static analysis (optional)
      run: |
        # try common tools if present; skip if not installed
        if command -v vendor/bin/phpstan >/dev/null 2>&1; then
          vendor/bin/phpstan analyse || echo "phpstan reported issues"
        else
          echo "phpstan not found — skipping static analysis"
        fi

  deploy:
    name: Deploy to cPanel
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer dependencies (production)
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Build Laravel app
      run: |
        # Only create .env if it does not already exist.
        if [ ! -f .env ]; then
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "No .env.example found — creating minimal .env"
            APP_KEY=$(php artisan key:generate --show 2>/dev/null || true)
            if [ -z "$APP_KEY" ]; then
              RAND=$(php -r "echo base64_encode(random_bytes(32));")
              APP_KEY="base64:$RAND"
            fi
            cat > .env <<EOF
APP_NAME=Laravel
APP_ENV=production
APP_KEY=$APP_KEY
APP_DEBUG=false
APP_URL=
EOF
          fi
          if ! grep -q '^APP_KEY=' .env || [ -z "$(awk -F= '/^APP_KEY=/{print $2}' .env)" ]; then
            php artisan key:generate
          fi
        else
          APP_KEY_VALUE=$(awk -F= '/^APP_KEY=/{print $2}' .env || true)
          if [ -z "$APP_KEY_VALUE" ]; then
            php artisan key:generate
          fi
        fi
        # Cache and optimize if artisan is available
        if command -v php >/dev/null && [ -f artisan ]; then
          php artisan config:cache || true
          php artisan route:cache || true
          php artisan view:cache || true
        fi

    - name: Run migrations from runner (only when enabled)
      if: ${{ secrets.RUN_MIGRATIONS == 'true' && secrets.DB_HOST != '' }}
      env:
        DB_CONNECTION: ${{ secrets.DB_CONNECTION || 'mysql' }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT || '3306' }}
        DB_DATABASE: ${{ secrets.DB_DATABASE }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        APP_ENV: production
      run: |
        echo "Running migrations from CI runner (ensure DB allows external connections)."
        echo "IMPORTANT: Backup your database before running migrations in production."
        if [ ! -f artisan ] || [ ! -f vendor/autoload.php ]; then
          echo "artisan or vendor missing; aborting migrations"
          exit 1
        fi
        php artisan migrate --force --no-interaction

    - name: Upload to cPanel via FTPS (lftp)
      env:
        CP_HOST: ${{ secrets.CPANEL_HOST }}
        CP_USER: ${{ secrets.CPANEL_USERNAME }}
        CP_PASS: ${{ secrets.CPANEL_PASSWORD }}
        CP_PATH: ${{ secrets.CPANEL_DEPLOY_PATH }}
      run: |
        sudo apt-get update -y
        sudo apt-get install -y lftp
        echo "Target CP_PATH: '$CP_PATH'"
        # Remote check & create if missing
        lftp -u "$CP_USER","$CP_PASS" -e "\
          set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftp:passive-mode true; \
          open ftps://$CP_HOST; \
          if (! test -d \"$CP_PATH\") { mkdir -p \"$CP_PATH\"; } \
          cd \"$CP_PATH\"; cls -la; bye" || true
        # Dry-run
        lftp -c "\
          set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftp:passive-mode true; \
          open -u \"$CP_USER\",\"$CP_PASS\" ftps://$CP_HOST; \
          mirror -R --only-newer --verbose --parallel=4 --dry-run --no-perms \
            --exclude-glob .git* --exclude-glob .env --exclude-glob .env.* --exclude-glob node_modules \
            --exclude-glob vendor --exclude-glob storage --exclude-glob .github ./ \"$CP_PATH\" \
        "
        # Actual upload
        lftp -c "\
          set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate false; set ftp:passive-mode true; \
          open -u \"$CP_USER\",\"$CP_PASS\" ftps://$CP_HOST; \
          mirror -R --only-newer --verbose --parallel=4 --no-perms \
            --exclude-glob .git* --exclude-glob .env --exclude-glob .env.* --exclude-glob node_modules \
            --exclude-glob vendor --exclude-glob storage --exclude-glob .github ./ \"$CP_PATH\" \
        "
